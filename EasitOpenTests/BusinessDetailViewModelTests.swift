//
//  BusinessDetailViewModelTests.swift
//  EasitOpenTests
//
//  Created by nissim amira on 05/12/2025.
//

import XCTest
@testable import EasitOpen

@MainActor
final class BusinessDetailViewModelTests: XCTestCase {
    var viewModel: BusinessDetailViewModel!
    var business: Business!
    var mockRefreshService: MockBusinessRefreshService!
    
    override func setUp() async throws {
        try await super.setUp()
        business = createSampleBusiness()
        mockRefreshService = MockBusinessRefreshService()
        viewModel = BusinessDetailViewModel(
            business: business,
            refreshService: mockRefreshService
        )
    }
    
    override func tearDown() async throws {
        viewModel = nil
        business = nil
        mockRefreshService = nil
        try await super.tearDown()
    }
    
    // MARK: - Label Editing Tests
    
    func testStartEditingLabel_WithCustomLabel() {
        business.customLabel = "My Favorite Place"
        
        viewModel.startEditingLabel()
        
        XCTAssertTrue(viewModel.showEditLabel)
        XCTAssertEqual(viewModel.editingLabel, "My Favorite Place")
    }
    
    func testStartEditingLabel_WithoutCustomLabel() {
        business.customLabel = nil
        
        viewModel.startEditingLabel()
        
        XCTAssertTrue(viewModel.showEditLabel)
        XCTAssertEqual(viewModel.editingLabel, business.name)
    }
    
    func testSaveLabel_WithText() {
        viewModel.editingLabel = "New Label"
        
        viewModel.saveLabel()
        
        XCTAssertEqual(business.customLabel, "New Label")
        XCTAssertFalse(viewModel.showEditLabel)
    }
    
    func testSaveLabel_WithEmptyText() {
        viewModel.editingLabel = ""
        
        viewModel.saveLabel()
        
        XCTAssertNil(business.customLabel)
        XCTAssertFalse(viewModel.showEditLabel)
    }
    
    func testClearLabel() {
        business.customLabel = "Old Label"
        
        viewModel.clearLabel()
        
        XCTAssertNil(business.customLabel)
    }
    
    // MARK: - Refresh Tests
    
    func testRefreshBusiness_Success_WithChanges() async throws {
        mockRefreshService.mockChanges = [
            BusinessChange(type: .hoursChanged(day: "Monday", oldHours: "9-5", newHours: "10-6"), businessName: "Test", businessId: "1")
        ]
        
        XCTAssertFalse(viewModel.isRefreshing)
        
        await viewModel.refreshBusiness()
        
        XCTAssertFalse(viewModel.isRefreshing)
        XCTAssertNotNil(viewModel.refreshMessage)
        XCTAssertEqual(viewModel.refreshMessageType, .success)
        XCTAssertTrue(viewModel.refreshMessage!.contains("1 change"))
    }
    
    func testRefreshBusiness_Success_NoChanges() async throws {
        mockRefreshService.mockChanges = []
        
        await viewModel.refreshBusiness()
        
        XCTAssertFalse(viewModel.isRefreshing)
        XCTAssertNotNil(viewModel.refreshMessage)
        XCTAssertEqual(viewModel.refreshMessageType, .info)
        XCTAssertTrue(viewModel.refreshMessage!.contains("up to date"))
    }
    
    func testRefreshBusiness_Error() async throws {
        mockRefreshService.shouldThrowError = true
        
        await viewModel.refreshBusiness()
        
        XCTAssertFalse(viewModel.isRefreshing)
        XCTAssertNotNil(viewModel.refreshMessage)
        XCTAssertEqual(viewModel.refreshMessageType, .error)
    }
    
    func testRefreshBusiness_MultipleChanges() async throws {
        mockRefreshService.mockChanges = [
            BusinessChange(type: .hoursChanged(day: "Monday", oldHours: "9-5", newHours: "10-6"), businessName: "Test", businessId: "1"),
            BusinessChange(type: .phoneChanged(old: "123", new: "456"), businessName: "Test", businessId: "1"),
            BusinessChange(type: .websiteChanged(old: "a.com", new: "b.com"), businessName: "Test", businessId: "1")
        ]
        
        await viewModel.refreshBusiness()
        
        XCTAssertTrue(viewModel.refreshMessage!.contains("3 changes"))
    }
    
    // MARK: - Schedule Tests
    
    func testSortedSchedule() {
        // Create schedule for weekdays 1, 3, 5 (out of order)
        business.openingHours = [
            DaySchedule(weekday: 5, openTime: 540, closeTime: 1020, isClosed: false),
            DaySchedule(weekday: 1, openTime: 540, closeTime: 1020, isClosed: false),
            DaySchedule(weekday: 3, openTime: 540, closeTime: 1020, isClosed: false)
        ]
        
        let sorted = viewModel.sortedSchedule()
        
        XCTAssertEqual(sorted[0].weekday, 1)
        XCTAssertEqual(sorted[1].weekday, 3)
        XCTAssertEqual(sorted[2].weekday, 5)
    }
    
    // MARK: - Day Name Tests
    
    func testDayName() {
        XCTAssertEqual(viewModel.dayName(for: 1), "Sunday")
        XCTAssertEqual(viewModel.dayName(for: 2), "Monday")
        XCTAssertEqual(viewModel.dayName(for: 3), "Tuesday")
        XCTAssertEqual(viewModel.dayName(for: 4), "Wednesday")
        XCTAssertEqual(viewModel.dayName(for: 5), "Thursday")
        XCTAssertEqual(viewModel.dayName(for: 6), "Friday")
        XCTAssertEqual(viewModel.dayName(for: 7), "Saturday")
    }
    
    // MARK: - Time String Tests
    
    func testTimeString() {
        // Test 9:00 AM (540 minutes)
        XCTAssertEqual(viewModel.timeString(from: 540), "9:00 AM")
        
        // Test 5:30 PM (1050 minutes)
        XCTAssertEqual(viewModel.timeString(from: 1050), "5:30 PM")
        
        // Test 12:00 PM (720 minutes)
        XCTAssertEqual(viewModel.timeString(from: 720), "12:00 PM")
        
        // Test midnight (0 minutes)
        XCTAssertEqual(viewModel.timeString(from: 0), "12:00 AM")
    }
    
    // MARK: - Is Today Tests
    
    func testIsToday() {
        let calendar = Calendar.current
        let today = calendar.component(.weekday, from: Date())
        
        XCTAssertTrue(viewModel.isToday(today))
        XCTAssertFalse(viewModel.isToday((today % 7) + 1))
    }
    
    // MARK: - Helper Methods
    
    private func createSampleBusiness() -> Business {
        let schedule = [
            DaySchedule(weekday: 1, openTime: 540, closeTime: 1020, isClosed: false),
            DaySchedule(weekday: 2, openTime: 540, closeTime: 1020, isClosed: false),
            DaySchedule(weekday: 3, openTime: 540, closeTime: 1020, isClosed: false)
        ]
        
        return Business(
            name: "Test Business",
            address: "123 Test St",
            latitude: 32.0,
            longitude: 34.0,
            phoneNumber: "123-456-7890",
            website: "https://test.com",
            openingHours: schedule
        )
    }
}
