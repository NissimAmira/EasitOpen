//
//  LocationManagerTests.swift
//  EasitOpenTests
//
//  Created by nissim amira on 05/12/2025.
//

import XCTest
import CoreLocation
@testable import EasitOpen

final class LocationManagerTests: XCTestCase {
    
    var locationManager: LocationManager!
    
    override func setUp() {
        super.setUp()
        locationManager = LocationManager.shared
        // Clear any existing home location
        locationManager.clearHomeLocation()
    }
    
    override func tearDown() {
        locationManager.clearHomeLocation()
        super.tearDown()
    }
    
    // MARK: - Home Location Storage Tests
    
    func testSetHomeLocationByCoordinates() {
        let latitude = 32.0853
        let longitude = 34.7818
        
        locationManager.setHomeLocation(latitude: latitude, longitude: longitude)
        
        XCTAssertNotNil(locationManager.homeLocation)
        if let homeLocation = locationManager.homeLocation {
            XCTAssertEqual(homeLocation.coordinate.latitude, latitude, accuracy: 0.0001)
            XCTAssertEqual(homeLocation.coordinate.longitude, longitude, accuracy: 0.0001)
        } else {
            XCTFail("Home location should not be nil")
        }
    }
    
    func testSetHomeLocationWithAddress() {
        let latitude = 32.0853
        let longitude = 34.7818
        let address = "123 Main St, Tel Aviv, Israel"
        
        locationManager.setHomeLocation(latitude: latitude, longitude: longitude, address: address)
        
        XCTAssertNotNil(locationManager.homeLocation)
        XCTAssertEqual(locationManager.homeAddress, address)
    }
    
    func testClearHomeLocation() {
        // First set a home location
        locationManager.setHomeLocation(latitude: 32.0853, longitude: 34.7818, address: "Test Address")
        XCTAssertNotNil(locationManager.homeLocation)
        XCTAssertNotNil(locationManager.homeAddress)
        
        // Then clear it
        locationManager.clearHomeLocation()
        
        XCTAssertNil(locationManager.homeLocation)
        XCTAssertNil(locationManager.homeAddress)
    }
    
    func testHomeLocationPersistence() {
        let latitude = 32.0853
        let longitude = 34.7818
        let address = "Test Address"
        
        // Set home location
        locationManager.setHomeLocation(latitude: latitude, longitude: longitude, address: address)
        
        // Verify data persisted by checking UserDefaults directly
        let savedLatitude = UserDefaults.standard.double(forKey: "homeLatitude")
        let savedLongitude = UserDefaults.standard.double(forKey: "homeLongitude")
        let savedAddress = UserDefaults.standard.string(forKey: "homeAddress")
        
        XCTAssertEqual(savedLatitude, latitude, accuracy: 0.0001)
        XCTAssertEqual(savedLongitude, longitude, accuracy: 0.0001)
        XCTAssertEqual(savedAddress, address)
    }
    
    func testSetCurrentLocationAsHome() {
        // Mock current location
        let mockLocation = CLLocation(latitude: 32.0853, longitude: 34.7818)
        locationManager.currentLocation = mockLocation
        
        locationManager.setCurrentLocationAsHome()
        
        XCTAssertNotNil(locationManager.homeLocation)
        if let homeLocation = locationManager.homeLocation {
            XCTAssertEqual(homeLocation.coordinate.latitude, mockLocation.coordinate.latitude, accuracy: 0.0001)
            XCTAssertEqual(homeLocation.coordinate.longitude, mockLocation.coordinate.longitude, accuracy: 0.0001)
        } else {
            XCTFail("Home location should not be nil")
        }
    }
    
    func testSetCurrentLocationAsHomeWithNilLocation() {
        locationManager.currentLocation = nil
        
        locationManager.setCurrentLocationAsHome()
        
        // Should not set home location if current location is nil
        XCTAssertNil(locationManager.homeLocation)
    }
    
    // MARK: - Authorization Status Tests
    
    func testInitialAuthorizationStatus() {
        // Should be set to a valid status
        let validStatuses: [CLAuthorizationStatus] = [
            .notDetermined, .restricted, .denied, .authorizedWhenInUse, .authorizedAlways
        ]
        
        XCTAssertTrue(validStatuses.contains(locationManager.authorizationStatus))
    }
    
    // MARK: - Edge Cases
    
    func testSetHomeLocationWithZeroCoordinates() {
        locationManager.setHomeLocation(latitude: 0, longitude: 0)
        
        // Zero coordinates are technically valid (Gulf of Guinea)
        XCTAssertNotNil(locationManager.homeLocation)
        XCTAssertEqual(locationManager.homeLocation?.coordinate.latitude, 0)
        XCTAssertEqual(locationManager.homeLocation?.coordinate.longitude, 0)
    }
    
    func testSetHomeLocationWithExtremeCoordinates() {
        // Test with extreme but valid coordinates
        locationManager.setHomeLocation(latitude: 89.9, longitude: 179.9)
        
        XCTAssertNotNil(locationManager.homeLocation)
        if let homeLocation = locationManager.homeLocation {
            XCTAssertEqual(homeLocation.coordinate.latitude, 89.9, accuracy: 0.1)
            XCTAssertEqual(homeLocation.coordinate.longitude, 179.9, accuracy: 0.1)
        } else {
            XCTFail("Home location should not be nil")
        }
    }
    
    func testMultipleHomeLocationUpdates() {
        // Set first location
        locationManager.setHomeLocation(latitude: 32.0, longitude: 34.0, address: "First")
        XCTAssertEqual(locationManager.homeAddress, "First")
        
        // Update to second location
        locationManager.setHomeLocation(latitude: 40.0, longitude: -74.0, address: "Second")
        XCTAssertEqual(locationManager.homeAddress, "Second")
        if let homeLocation = locationManager.homeLocation {
            XCTAssertEqual(homeLocation.coordinate.latitude, 40.0, accuracy: 0.1)
        }
        
        // Update to third location
        locationManager.setHomeLocation(latitude: 51.5, longitude: -0.1, address: "Third")
        XCTAssertEqual(locationManager.homeAddress, "Third")
        if let homeLocation = locationManager.homeLocation {
            XCTAssertEqual(homeLocation.coordinate.latitude, 51.5, accuracy: 0.1)
        }
    }
}
