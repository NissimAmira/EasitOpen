//
//  NotificationManagerTests.swift
//  EasitOpenTests
//
//  Created by nissim amira on 04/12/2025.
//

import XCTest
import UserNotifications
@testable import EasitOpen

final class NotificationManagerTests: XCTestCase {
    
    var notificationManager: NotificationManager!
    
    override func setUp() {
        super.setUp()
        notificationManager = NotificationManager.shared
    }
    
    // MARK: - BusinessChange Tests
    
    func testBusinessChangeHoursChanged() {
        let change = BusinessChange(
            type: .hoursChanged(
                day: "Monday",
                oldHours: "9:00 AM - 5:00 PM",
                newHours: "10:00 AM - 6:00 PM"
            ),
            businessName: "Test Coffee Shop",
            businessId: "test-id"
        )
        
        XCTAssertEqual(change.businessName, "Test Coffee Shop")
        XCTAssertEqual(change.businessId, "test-id")
    }
    
    func testBusinessChangeDayClosed() {
        let change = BusinessChange(
            type: .dayClosed(day: "Sunday"),
            businessName: "Test Restaurant",
            businessId: "test-id-2"
        )
        
        XCTAssertEqual(change.businessName, "Test Restaurant")
        XCTAssertEqual(change.businessId, "test-id-2")
    }
    
    func testBusinessChangeDayOpened() {
        let change = BusinessChange(
            type: .dayOpened(day: "Saturday", hours: "10:00 AM - 4:00 PM"),
            businessName: "Test Store",
            businessId: "test-id-3"
        )
        
        XCTAssertEqual(change.businessName, "Test Store")
    }
    
    func testBusinessChangePhoneChanged() {
        let change = BusinessChange(
            type: .phoneChanged(old: "123-456-7890", new: "098-765-4321"),
            businessName: "Test Business",
            businessId: "test-id-4"
        )
        
        XCTAssertEqual(change.businessName, "Test Business")
    }
    
    func testBusinessChangeWebsiteChanged() {
        let change = BusinessChange(
            type: .websiteChanged(old: "https://old.com", new: "https://new.com"),
            businessName: "Test Shop",
            businessId: "test-id-5"
        )
        
        XCTAssertEqual(change.businessName, "Test Shop")
    }
    
    // MARK: - Authorization Status Tests
    
    func testInitialAuthorizationStatusIsNotDetermined() {
        // Note: This test may fail if notifications were already enabled in simulator
        // The initial state should be .notDetermined for a fresh install
        let status = notificationManager.authorizationStatus
        XCTAssertTrue(
            status == .notDetermined || status == .authorized || status == .denied,
            "Status should be one of the valid UNAuthorizationStatus values"
        )
    }
    
    func testCheckAuthorizationStatusUpdatesState() {
        let expectation = expectation(description: "Authorization status checked")
        
        notificationManager.checkAuthorizationStatus()
        
        // Wait a moment for the async operation
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
            // Status should be updated (not necessarily authorized, but should be checked)
            expectation.fulfill()
        }
        
        waitForExpectations(timeout: 1.0)
    }
    
    // MARK: - Multiple Change Types Test
    
    func testMultipleChangesForSameBusiness() {
        let changes = [
            BusinessChange(
                type: .hoursChanged(day: "Monday", oldHours: "9:00 AM - 5:00 PM", newHours: "10:00 AM - 6:00 PM"),
                businessName: "Multi-Change Shop",
                businessId: "multi-id"
            ),
            BusinessChange(
                type: .phoneChanged(old: "123-456-7890", new: "098-765-4321"),
                businessName: "Multi-Change Shop",
                businessId: "multi-id"
            ),
            BusinessChange(
                type: .dayClosed(day: "Sunday"),
                businessName: "Multi-Change Shop",
                businessId: "multi-id"
            )
        ]
        
        XCTAssertEqual(changes.count, 3)
        XCTAssertTrue(changes.allSatisfy { $0.businessId == "multi-id" })
        XCTAssertTrue(changes.allSatisfy { $0.businessName == "Multi-Change Shop" })
    }
    
    // MARK: - Edge Cases
    
    func testBusinessChangeWithEmptyStrings() {
        let change = BusinessChange(
            type: .hoursChanged(day: "", oldHours: "", newHours: ""),
            businessName: "",
            businessId: ""
        )
        
        XCTAssertEqual(change.businessName, "")
        XCTAssertEqual(change.businessId, "")
    }
    
    func testBusinessChangePhoneChangedWithNilValues() {
        let changeOldNil = BusinessChange(
            type: .phoneChanged(old: nil, new: "123-456-7890"),
            businessName: "Test",
            businessId: "test-id"
        )
        
        let changeNewNil = BusinessChange(
            type: .phoneChanged(old: "123-456-7890", new: nil),
            businessName: "Test",
            businessId: "test-id"
        )
        
        let changeBothNil = BusinessChange(
            type: .phoneChanged(old: nil, new: nil),
            businessName: "Test",
            businessId: "test-id"
        )
        
        XCTAssertEqual(changeOldNil.businessName, "Test")
        XCTAssertEqual(changeNewNil.businessName, "Test")
        XCTAssertEqual(changeBothNil.businessName, "Test")
    }
    
    func testBusinessChangeWebsiteChangedWithNilValues() {
        let changeOldNil = BusinessChange(
            type: .websiteChanged(old: nil, new: "https://new.com"),
            businessName: "Test",
            businessId: "test-id"
        )
        
        let changeNewNil = BusinessChange(
            type: .websiteChanged(old: "https://old.com", new: nil),
            businessName: "Test",
            businessId: "test-id"
        )
        
        XCTAssertEqual(changeOldNil.businessName, "Test")
        XCTAssertEqual(changeNewNil.businessName, "Test")
    }
}
