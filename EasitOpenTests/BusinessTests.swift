//
//  BusinessTests.swift
//  EasitOpenTests
//
//  Created by nissim amira on 04/12/2025.
//

import XCTest
import SwiftData
@testable import EasitOpen
internal import SwiftUI

final class BusinessTests: XCTestCase {
    
    func testBusinessIsOpenDuringHours() {
        // Create a schedule for today, 9 AM - 5 PM
        let calendar = Calendar.current
        let today = calendar.component(.weekday, from: Date())
        let schedule = DaySchedule(weekday: today, openTime: 540, closeTime: 1020)
        
        let business = Business(
            name: "Test Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0,
            openingHours: [schedule]
        )
        
        // Test will pass if executed during business hours (9 AM - 5 PM)
        // In production, you'd inject time for deterministic testing
        let hour = calendar.component(.hour, from: Date())
        let isBusinessHours = hour >= 9 && hour < 17
        XCTAssertEqual(business.isOpen, isBusinessHours)
    }
    
    func testDisplayNameUsesCustomLabel() {
        let business = Business(
            name: "Original Name",
            address: "Test Address",
            latitude: 0,
            longitude: 0
        )
        
        // Without custom label
        XCTAssertEqual(business.displayName, "Original Name")
        
        // With custom label
        business.customLabel = "My Custom Name"
        XCTAssertEqual(business.displayName, "My Custom Name")
    }
    
    func testBusinessInitialization() {
        let business = Business(
            name: "Coffee Shop",
            address: "123 Main St",
            latitude: 32.0853,
            longitude: 34.7818,
            phoneNumber: "123-456-7890",
            website: "https://example.com"
        )
        
        XCTAssertEqual(business.name, "Coffee Shop")
        XCTAssertEqual(business.address, "123 Main St")
        XCTAssertEqual(business.latitude, 32.0853, accuracy: 0.0001)
        XCTAssertEqual(business.longitude, 34.7818, accuracy: 0.0001)
        XCTAssertEqual(business.phoneNumber, "123-456-7890")
        XCTAssertEqual(business.website, "https://example.com")
        XCTAssertNil(business.customLabel)
    }
    
    func testCustomLabelCanBeCleared() {
        let business = Business(
            name: "Test Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0
        )
        
        business.customLabel = "Custom"
        XCTAssertEqual(business.displayName, "Custom")
        
        business.customLabel = nil
        XCTAssertEqual(business.displayName, "Test Business")
    }
    
    // MARK: - Status Tests
    
    func testBusinessStatusOpen() {
        // Create a schedule that opened 1 hour ago and closes in 90 minutes
        let calendar = Calendar.current
        let now = Date()
        let today = calendar.component(.weekday, from: now)
        let currentHour = calendar.component(.hour, from: now)
        let currentMinute = calendar.component(.minute, from: now)
        let currentMinutes = currentHour * 60 + currentMinute
        
        let openTime = currentMinutes - 60  // Opened 1 hour ago
        let closeTime = currentMinutes + 90 // Closes in 90 minutes (>60, so OPEN)
        let schedule = DaySchedule(weekday: today, openTime: openTime, closeTime: closeTime)
        
        let business = Business(
            name: "Open Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0,
            openingHours: [schedule]
        )
        
        XCTAssertEqual(business.status, .open, "Business should be OPEN when more than 60 minutes until closing")
        XCTAssertTrue(business.isOpen, "isOpen should be true for open status")
    }
    
    func testBusinessStatusClosingSoon() {
        // Create a schedule that closes in 45 minutes
        let calendar = Calendar.current
        let now = Date()
        let today = calendar.component(.weekday, from: now)
        let currentHour = calendar.component(.hour, from: now)
        let currentMinute = calendar.component(.minute, from: now)
        let currentMinutes = currentHour * 60 + currentMinute
        
        let openTime = currentMinutes - 60  // Opened 1 hour ago
        let closeTime = currentMinutes + 45 // Closes in 45 minutes
        let schedule = DaySchedule(weekday: today, openTime: openTime, closeTime: closeTime)
        
        let business = Business(
            name: "Closing Soon Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0,
            openingHours: [schedule]
        )
        
        XCTAssertEqual(business.status, .closingSoon, "Business should be CLOSING SOON when within 60 minutes of closing")
        XCTAssertTrue(business.isOpen, "isOpen should be true for closingSoon status")
    }
    
    func testBusinessStatusClosingSoonEdgeCase() {
        // Test exactly 60 minutes until closing
        let calendar = Calendar.current
        let now = Date()
        let today = calendar.component(.weekday, from: now)
        let currentHour = calendar.component(.hour, from: now)
        let currentMinute = calendar.component(.minute, from: now)
        let currentMinutes = currentHour * 60 + currentMinute
        
        let openTime = currentMinutes - 60
        let closeTime = currentMinutes + 60 // Exactly 60 minutes
        let schedule = DaySchedule(weekday: today, openTime: openTime, closeTime: closeTime)
        
        let business = Business(
            name: "Edge Case Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0,
            openingHours: [schedule]
        )
        
        XCTAssertEqual(business.status, .closingSoon, "Business should be CLOSING SOON at exactly 60 minutes")
    }
    
    func testBusinessStatusClosed() {
        // Create a schedule for yesterday
        let calendar = Calendar.current
        let today = calendar.component(.weekday, from: Date())
        let yesterday = today == 1 ? 7 : today - 1
        
        let schedule = DaySchedule(weekday: yesterday, openTime: 540, closeTime: 1020)
        
        let business = Business(
            name: "Closed Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0,
            openingHours: [schedule]
        )
        
        XCTAssertEqual(business.status, .closed, "Business should be CLOSED when it's not the scheduled day")
        XCTAssertFalse(business.isOpen, "isOpen should be false for closed status")
    }
    
    func testBusinessStatusClosedBeforeOpening() {
        // Create a schedule that opens in 2 hours
        let calendar = Calendar.current
        let now = Date()
        let today = calendar.component(.weekday, from: now)
        let currentHour = calendar.component(.hour, from: now)
        let currentMinute = calendar.component(.minute, from: now)
        let currentMinutes = currentHour * 60 + currentMinute
        
        let openTime = currentMinutes + 120 // Opens in 2 hours
        let closeTime = currentMinutes + 300 // Closes in 5 hours
        let schedule = DaySchedule(weekday: today, openTime: openTime, closeTime: closeTime)
        
        let business = Business(
            name: "Not Yet Open Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0,
            openingHours: [schedule]
        )
        
        XCTAssertEqual(business.status, .closed, "Business should be CLOSED before opening time")
        XCTAssertFalse(business.isOpen)
    }
    
    func testBusinessStatusClosedAfterClosing() {
        // Create a schedule that closed 1 hour ago
        let calendar = Calendar.current
        let now = Date()
        let today = calendar.component(.weekday, from: now)
        let currentHour = calendar.component(.hour, from: now)
        let currentMinute = calendar.component(.minute, from: now)
        let currentMinutes = currentHour * 60 + currentMinute
        
        let openTime = currentMinutes - 300 // Opened 5 hours ago
        let closeTime = currentMinutes - 60 // Closed 1 hour ago
        let schedule = DaySchedule(weekday: today, openTime: openTime, closeTime: closeTime)
        
        let business = Business(
            name: "Already Closed Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0,
            openingHours: [schedule]
        )
        
        XCTAssertEqual(business.status, .closed, "Business should be CLOSED after closing time")
        XCTAssertFalse(business.isOpen)
    }
    
    func testBusinessStatusWithNoSchedule() {
        let business = Business(
            name: "No Schedule Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0,
            openingHours: []
        )
        
        XCTAssertEqual(business.status, .closed, "Business with no schedule should be CLOSED")
        XCTAssertFalse(business.isOpen)
    }
    
    // MARK: - Status Enum Tests
    
    func testBusinessStatusText() {
        XCTAssertEqual(BusinessStatus.open.text, "OPEN")
        XCTAssertEqual(BusinessStatus.closingSoon.text, "CLOSING SOON")
        XCTAssertEqual(BusinessStatus.closed.text, "CLOSED")
    }
    
    func testBusinessStatusColors() {
        XCTAssertEqual(BusinessStatus.open.color, .green)
        XCTAssertEqual(BusinessStatus.closingSoon.color, .orange)
        XCTAssertEqual(BusinessStatus.closed.color, .red)
    }
    
    // MARK: - Data Tracking Tests
    
    func testBusinessInitializationSetsTimestamps() {
        let beforeCreation = Date()
        
        let business = Business(
            name: "Test Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0
        )
        
        let afterCreation = Date()
        
        // lastUpdated should be set to current time on creation
        XCTAssertGreaterThanOrEqual(business.lastUpdated, beforeCreation)
        XCTAssertLessThanOrEqual(business.lastUpdated, afterCreation)
        
        // lastChecked should be nil initially
        XCTAssertNil(business.lastChecked)
    }
    
    func testBusinessStoresGooglePlaceId() {
        let placeId = "ChIJN1t_tDeuEmsRUsoyG83frY4"
        
        let business = Business(
            googlePlaceId: placeId,
            name: "Test Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0
        )
        
        XCTAssertEqual(business.googlePlaceId, placeId)
    }
    
    // MARK: - Staleness Tests
    
    func testIsDataStaleFreshData() {
        // Business just created - should not be stale
        let business = Business(
            name: "Fresh Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0
        )
        
        XCTAssertFalse(business.isDataStale, "Freshly created business should not be stale")
    }
    
    func testIsDataStaleOldData() {
        let business = Business(
            name: "Old Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0
        )
        
        // Manually set lastUpdated to 8 days ago
        let calendar = Calendar.current
        business.lastUpdated = calendar.date(byAdding: .day, value: -8, to: Date())!
        
        XCTAssertTrue(business.isDataStale, "Business with 8-day-old data should be stale")
    }
    
    func testIsDataStaleEdgeCase() {
        let business = Business(
            name: "Edge Case Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0
        )
        
        // Set to exactly 7 days ago
        let calendar = Calendar.current
        business.lastUpdated = calendar.date(byAdding: .day, value: -7, to: Date())!
        
        // At exactly 7 days, should not be stale (>7 required)
        XCTAssertFalse(business.isDataStale, "Business at exactly 7 days should not be stale")
    }
    
    func testLastUpdatedTextFormat() {
        let business = Business(
            name: "Test Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0
        )
        
        // Set to 2 hours ago
        let calendar = Calendar.current
        business.lastUpdated = calendar.date(byAdding: .hour, value: -2, to: Date())!
        
        let text = business.lastUpdatedText
        
        // Should contain relative time format (e.g., "2 hr ago", "2 hours ago")
        XCTAssertFalse(text.isEmpty, "lastUpdatedText should not be empty")
        XCTAssertTrue(text.contains("ago") || text.contains("hr"), "Should be a relative time format")
    }
    
    func testLastUpdatedTextForRecentUpdate() {
        let business = Business(
            name: "Test Business",
            address: "Test Address",
            latitude: 0,
            longitude: 0
        )
        
        // Just created - lastUpdated is now
        let text = business.lastUpdatedText
        
        // Should show something like "just now" or "0 min ago"
        XCTAssertFalse(text.isEmpty)
    }
}
